FROM python:3.12-slim

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY pyproject.toml ./

RUN python -c "import tomllib; from pathlib import Path; data = tomllib.loads(Path('pyproject.toml').read_text('utf-8')); proj_deps = data.get('project', {}).get('dependencies', []); neural_deps = data.get('project', {}).get('neural_dependencies', []); deps = proj_deps + neural_deps; Path('/tmp/neural_requirements.txt').write_text('\n'.join(deps))"
RUN cat /tmp/neural_requirements.txt

RUN pip install --upgrade pip setuptools wheel && \
    pip install -r /tmp/neural_requirements.txt

COPY . .

ENV HF_HOME=/cache/huggingface \
    TORCH_HOME=/cache/torch \
    TORCH_KERNEL_CACHE_PATH=/cache/torch_kernels \
    MODEL_PATH=/models/Qwen2-7B-Instruct

EXPOSE 8000

CMD ["uvicorn", "neuralnet.model:app", "--host", "0.0.0.0", "--port", "8000"]
